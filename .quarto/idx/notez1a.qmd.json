{"title":"Logic Notebook","markdown":{"headingText":"Logic Notebook","containsRefs":false,"markdown":"\n```{r}\nsuppressWarnings(suppressPackageStartupMessages({\n  library(data.table)\n  library(tidyverse)\n  library(tidymodels)\n  library(naniar)\n  library(readxl)\n  library(janitor)\n  library(rmarkdown)\n  library(knitr)\n  library(kableExtra)\n  library(modelsummary)\n  library(DoubleML)\n  library(mlr3)\n  library(broom)\n  library(ranger)\n  library(sandwich)\n  library(lmtest)\n  library(mlr3learners)\n  library(readr)\n  library(MatchIt)\n  library(ggplot2)\n  library(dplyr)\n  library(summarytools)\n  library(DataExplorer)\n  library(mlr3learners)\n  library(mlr3measures)\n  library(mlr3resampling)\n}))\nset.seed(5824769)\noptions(warn = -1)\noptions(device.ask.default = FALSE)\ndata010a <- rnorm(1000000)\nhist(\n  data010a,\n  labels = TRUE,\n  col = \"grey\",\n  breaks = 100,\n  main = \"Histogram of Random Data\",\n  xlab = \"Value\",\n  ylab = \"Frequency\"\n)\nrdx = rnorm(1000)\nrdy = as.numeric(rdx > 0)\nrdix = sample(1:1000, 100)\nrdy[rdix] = 1 - rdy[rdix]\nrdf = data.frame(rdx, rdy)\nplot(rdf$rdx, rdf$rdy)\nm <- glm(rdy ~ rdx, data = rdf, family = binomial())\nxs <- seq(min(rdf$rdx), max(rdf$rdx), length.out = 300)\nlines(\n  xs,\n  predict(m, newdata = data.frame(rdx = xs), type = \"response\"),\n  lwd = 2\n)\nload(\"correctional_stats_report_environment1b.RData\")\n\ndataframe_original <- df\ncols_to_rename <- setdiff(names(dataframe_original), \"unique_individual_id\")\nnum_to_letters <- function(n) {\n  sapply(n, function(i) {\n    out <- \"\"\n    while (i > 0) {\n      i <- i - 1\n      out <- paste0(letters[(i %% 26) + 1], out)\n      i <- i %/% 26\n    }\n    out\n  })\n}\nnew_names <- paste0(\"x1\", num_to_letters(seq_along(cols_to_rename)))\nnames(dataframe_original)[match(\n  cols_to_rename,\n  names(dataframe_original)\n)] <- new_names\nknitr::kable(\n  head(\n    dataframe_original[, setdiff(\n      names(dataframe_original),\n      \"unique_individual_id\"\n    )],\n    10\n  ),\n  booktabs = TRUE,\n  longtable = TRUE,\n  caption = \"Ontario Restrictive Confinement Dataframe (2023-2025)\"\n)\n\nregion_names <- c(\"Central\", \"Eastern\", \"Northern\", \"Toronto\", \"Western\")\nage_levels <- c(\"18 to 24\", \"25 to 49\", \"50+\")\nsex_levels <- c(\"Male\", \"Female\")\nyears <- 2023:2025\ndataframe_original1b <- copy(dataframe_original)\ndf_rc <- as.data.table(df)\ndf_rc[, end_fiscal_year := as.integer(end_fiscal_year)]\ndf_rc[, age_category := factor(age_category, levels = age_levels)]\ndf_rc[, gender := factor(gender, levels = sex_levels)]\ndf_rc[,\n  region_at_time_of_placement := factor(\n    region_at_time_of_placement,\n    levels = region_names\n  )\n]\nget_region_by_age <- function(D, yr, sex = NULL) {\n  tmp <- D[\n    end_fiscal_year == yr &\n      !is.na(age_category) &\n      !is.na(region_at_time_of_placement)\n  ]\n  if (!is.null(sex)) {\n    tmp <- tmp[gender == sex]\n  }\n  tab <- tmp[,\n    .(n = uniqueN(unique_individual_id)),\n    by = .(age_category, region_at_time_of_placement)\n  ]\n  grid <- CJ(\n    age_category = age_levels,\n    region_at_time_of_placement = region_names,\n    unique = TRUE\n  )\n  tab <- merge(\n    grid,\n    tab,\n    by = c(\"age_category\", \"region_at_time_of_placement\"),\n    all.x = TRUE\n  )\n  tab[is.na(n), n := 0L]\n  wide <- dcast(\n    tab,\n    age_category ~ region_at_time_of_placement,\n    value.var = \"n\"\n  )\n  S <- as.matrix(wide[, -1])\n  rownames(S) <- wide$age_category\n  den <- rowSums(S)\n  P <- sweep(S, 1, den, \"/\")\n  P[den == 0, ] <- NA_real_\n  list(S = S, P = P)\n}\nP_year <- list()\nS_year <- list()\nfor (yr in years) {\n  out_all <- get_region_by_age(df_rc, yr)\n  P <- out_all$P\n  S_year[[as.character(yr)]] <- out_all$S\n  P_year[[as.character(yr)]] <- P\n  cols <- seq_len(ncol(P))\n  matplot(\n    P,\n    type = \"l\",\n    lwd = 2,\n    lty = 1,\n    col = cols,\n    xaxt = \"n\",\n    xlab = \"Age Group\",\n    ylab = \"Proportion\",\n    main = paste0(yr, \" Region at Time of Placement by Age Group\")\n  )\n  axis(1, at = seq_len(nrow(P)), labels = rownames(P))\n  legend(\n    \"topright\",\n    legend = colnames(P),\n    col = cols,\n    lty = 1,\n    lwd = 2,\n    bty = \"n\"\n  )\n  par(mfrow = c(1, 2), mar = c(4, 4, 3, 1))\n  for (sex in c(\"Male\", \"Female\")) {\n    out_sex <- get_region_by_age(df_rc, yr, sex = sex)\n    Psex <- out_sex$P\n    cols <- seq_len(ncol(Psex))\n    matplot(\n      Psex,\n      type = \"l\",\n      lwd = 2,\n      lty = 1,\n      col = cols,\n      xaxt = \"n\",\n      xlab = \"Age Group\",\n      ylab = \"Proportion\",\n      main = paste0(yr, \" RTP (\", sex, \")\")\n    )\n    axis(1, at = seq_len(nrow(Psex)), labels = rownames(Psex))\n    legend(\n      \"topright\",\n      legend = colnames(Psex),\n      col = cols,\n      lty = 1,\n      lwd = 2,\n      bty = \"n\"\n    )\n  }\n  par(mfrow = c(1, 1))\n}\n\n\nac1b <- df |>\n  mutate(\n    ac1a = factor(\n      dplyr::recode(\n        as.character(age_category),\n        \"18 to 24\" = \"1\",\n        \"25 to 49\" = \"2\",\n        \"50+\" = \"3\"\n      ),\n      levels = c(\"1\", \"2\", \"3\"),\n      ordered = TRUE\n    )\n  ) |>\n  group_by(ac1a) |>\n  summarise(\n    f = dplyr::n(),\n    n = dplyr::n_distinct(unique_individual_id),\n    .groups = \"drop\"\n  ) |>\n  arrange(ac1a) |>\n  mutate(\n    p = round(n / sum(n), 2),\n    pct = round(100 * n / sum(n), 2),\n    rate = round(10000 * n / sum(n), 2)\n  )\nvars <- c(\n  \"gender\",\n  \"age_category\",\n  \"region_at_time_of_placement\",\n  \"region_most_recent_placement\",\n  \"mental_health_alert\",\n  \"suicide_watch_alert\",\n  \"suicide_risk_alert\"\n)\ndf.counts <- df |>\n  group_by(region_at_time_of_placement) |>\n  summarise(\n    f = n(),\n    count = n_distinct(unique_individual_id),\n    .groups = \"drop\"\n  ) |>\n  mutate(p = count / sum(count), pct = p * 100, rate = p * 10000)\ndf.counts_ac_year <- df |>\n  pivot_longer(all_of(vars), names_to = \"variable\", values_to = \"level\") |>\n  group_by(end_fiscal_year, variable, level) |>\n  summarise(\n    f = n(),\n    count = n_distinct(unique_individual_id),\n    .groups = \"drop\"\n  ) |>\n  group_by(end_fiscal_year, variable) |>\n  mutate(p = count / sum(count), pct = 100 * p, rate = 10000 * p) |>\n  ungroup()\ndf.counts_year <- df |>\n  group_by(end_fiscal_year, region_at_time_of_placement) |>\n  summarise(\n    f = n(),\n    count = n_distinct(unique_individual_id),\n    .groups = \"drop\"\n  ) |>\n  group_by(end_fiscal_year) |>\n  mutate(p = count / sum(count), pct = 100 * p, rate = 10000 * p) |>\n  ungroup()\ndf.person_freq_year <- df |>\n  group_by(\n    end_fiscal_year,\n    region_at_time_of_placement,\n    unique_individual_id\n  ) |>\n  summarise(freq = n(), .groups = \"drop\")\necdf_age <- ac1b |>\n  arrange(ac1a) |>\n  mutate(ecdf = cumsum(p))\nevents_per_person <- df |>\n  count(unique_individual_id, name = \"n_events\") |>\n  pull(n_events)\ntotal_people <- df |>\n  summarise(N = n_distinct(unique_individual_id)) |>\n  pull(N)\ndf_overall <- df |>\n  select(unique_individual_id, all_of(vars)) |>\n  pivot_longer(all_of(vars), names_to = \"variable\", values_to = \"level\") |>\n  group_by(variable, level) |>\n  summarise(\n    f = n(),\n    count = n_distinct(unique_individual_id),\n    .groups = \"drop\"\n  ) |>\n  mutate(\n    p = count / total_people,\n    pct = 100 * p,\n    rate = 10000 * p\n  )\n\nknitr::kable(\n  ecdf_age,\n  booktabs = TRUE,\n  longtable = TRUE,\n  caption = '(`ecdf_age`)'\n)\nknitr::kable(\n  df.counts,\n  booktabs = TRUE,\n  longtable = TRUE,\n  caption = '(`df.counts`).'\n)\nknitr::kable(\n  df.counts_year,\n  booktabs = TRUE,\n  longtable = TRUE,\n  caption = '(`df.counts_year`)'\n)\nknitr::kable(\n  df_overall,\n  booktabs = TRUE,\n  longtable = TRUE,\n  caption = '(`df_overall`)'\n)\nknitr::kable(\n  df.counts_ac_year,\n  booktabs = TRUE,\n  longtable = TRUE,\n  caption = '(`df.counts_ac_year`)'\n)\n\nlibrary(DoubleML)\nlibrary(mlr3)\nlibrary(mlr3learners)\nlibrary(data.table)\nlibrary(dplyr)\nlibrary(parallel)\nlgr::get_logger(\"mlr3\")$set_threshold(\"warn\")\n# \"regr.lm\" instead of \"regr.ranger\" utilized (disclaimer)\n# \"classif.log_reg\", predict_type = \"prob\" instead of classif.ranger\n# cores <- max(1L, parallel::detectCores() - 1L)\n# yn_cols <- c(\"mental_health_alert\", \"suicide_risk_alert\", \"suicide_watch_alert\")\n# dfn <- dfn %>%\n#   mutate(across(\n#     all_of(yn_cols),\n#     ~ factor(dplyr::if_else(.x == \"Yes\", 1L, 0L), levels = c(0, 1))\n#   ))\n# dt <- as.data.table(dfn)\n# dt[, number_of_placements := as.integer(number_of_placements)]\n# dt <- dt[!is.na(number_of_placements) & number_of_placements > 0L]\n# N_expanded <- sum(dt$number_of_placements)\n# message(\"Expanded N = \", format(N_expanded, big.mark = \",\"))\n# dt <- dt[rep.int(seq_len(.N), number_of_placements)]\n# dt[, Y := as.integer(suicide_risk_alert) - 1L]\n# dt[, D := as.integer(mental_health_alert) - 1L]\n# stopifnot(identical(sort(unique(dt$D)), c(0L, 1L)))\n# dt[, cluster_id := as.factor(unique_individual_id)]\n# ml_g <- lrn(\"regr.lm\")\n# ml_m <- lrn(\"classif.log_reg\", predict_type = \"prob\")\n# fit_irm_ate_atte <- function(dsub, x_cols, tag) {\n#   dml_data <- DoubleMLClusterData$new(\n#     data = dsub,\n#     y_col = \"Y\",\n#     d_cols = \"D\",\n#     x_cols = x_cols,\n#     cluster_cols = \"cluster_id\"\n#   )\n#   set.seed(1111111111)\n#   obj_ate <- DoubleMLIRM$new(\n#     dml_data,\n#     ml_g = ml_g,\n#     ml_m = ml_m,\n#     n_folds = 3,\n#     n_rep = 1,\n#     score = \"ATE\"\n#   )\n#   obj_ate$fit()\n#   set.seed(1111111111)\n#   obj_atte <- DoubleMLIRM$new(\n#     dml_data,\n#     ml_g = ml_g,\n#     ml_m = ml_m,\n#     n_folds = 3,\n#     n_rep = 1,\n#     score = \"ATTE\"\n#   )\n#   obj_atte$fit()\n#   mk <- function(obj, estimand) {\n#     ci <- obj$confint(level = 0.95)\n#     data.table(\n#       group = tag,\n#       estimand = estimand,\n#       effect = as.numeric(obj$coef),\n#       se = as.numeric(obj$se),\n#       t_value = as.numeric(obj$t_stat),\n#       p_value = as.numeric(obj$pval),\n#       ci_low = as.numeric(ci[1, 1]),\n#       ci_high = as.numeric(ci[1, 2])\n#     )\n#   }\n#   rbind(mk(obj_ate, \"ATE\"), mk(obj_atte, \"ATTE\"))\n# }\n# x_cols_pool <- c(\n#   \"gender\",\n#   \"age_category\",\n#   \"region_at_time_of_placement\",\n#   \"region_most_recent_placement\",\n#   \"end_fiscal_year\"\n# )\n# dt[, (x_cols_pool) := lapply(.SD, as.factor), .SDcols = x_cols_pool]\n# keep_pool <- complete.cases(dt[,\n#   c(\"Y\", \"D\", \"cluster_id\", x_cols_pool),\n#   with = FALSE\n# ])\n# dsub_pool <- dt[keep_pool, c(\"Y\", \"D\", \"cluster_id\", x_cols_pool), with = FALSE]\n# res_pool <- fit_irm_ate_atte(dsub_pool, x_cols_pool, tag = \"Pooled 2023-25\")\n# years <- sort(unique(dt$end_fiscal_year))\n# x_cols_year <- c(\n#   \"gender\",\n#   \"age_category\",\n#   \"region_at_time_of_placement\",\n#   \"region_most_recent_placement\"\n# )\n# res_by_year <- rbindlist(lapply(years, function(yy) {\n#   sub <- dt[end_fiscal_year == yy]\n#   sub[, (x_cols_year) := lapply(.SD, as.factor), .SDcols = x_cols_year]\n#   keep_y <- complete.cases(sub[,\n#     c(\"Y\", \"D\", \"cluster_id\", x_cols_year),\n#     with = FALSE\n#   ])\n#   dsub_y <- sub[keep_y, c(\"Y\", \"D\", \"cluster_id\", x_cols_year), with = FALSE]\n#   fit_irm_ate_atte(dsub_y, x_cols_year, tag = as.character(yy))\n# }))\n\nsetHook(packageEvent(\"graphics\", \"onLoad\"), function(...) par(ask = FALSE))\nsetnames(\n  dataframe_original,\n  old = c(\n    \"x1a\",\n    \"unique_individual_id\",\n    \"x1b\",\n    \"x1c\",\n    \"x1d\",\n    \"x1f\",\n    \"x1g\",\n    \"x1h\",\n    \"x1i\"\n  ),\n  new = c(\"year\", \"id\", \"regA\", \"regB\", \"sex\", \"binA\", \"binB\", \"binC\", \"np\")\n)\n\ndt1b <- as.data.table(dataframe_original)\nplacement_dist <- dt1b[,\n  .(\n    total_placements = sum(np),\n    unique_status_rows = .N\n  ),\n  by = .(id, year)\n]\n\nsummary_report <- placement_dist[,\n  .(\n    total_unique_people = .N,\n    avg_placements_per_person = mean(total_placements),\n    median_placements = median(total_placements),\n    max_placements = max(total_placements),\n    avg_status_changes = mean(unique_status_rows),\n    max_status_changes = max(unique_status_rows)\n  ),\n  by = year\n][order(year)]\n\n# Summary of Placement Distribution by Year\nknitr::kable(\n  summary_report,\n  booktabs = TRUE,\n  longtable = TRUE,\n  caption = '(`summary_report`)'\n)\n# Frequency of Status Combinations per Person\nas.data.frame(table(placement_dist$unique_status_rows))\nplacement_rows <- as.data.frame(table(placement_dist$unique_status_rows))\nknitr::kable(\n  placement_rows,\n  booktabs = TRUE,\n  longtable = TRUE,\n  caption = '(`placement_rows`)'\n)\ntop_rows <- placement_dist[order(-unique_status_rows)][1:10]\nknitr::kable(\n  top_rows,\n  booktabs = TRUE,\n  longtable = TRUE,\n  caption = '(`top_rows`)'\n)\n\nrow_counts_summary <- placement_dist[,\n  .(count_of_people = .N),\n  by = unique_status_rows\n][order(unique_status_rows)]\n# how many people have 1, 2,...n rows ?:!\nknitr::kable(\n  row_counts_summary,\n  booktabs = TRUE,\n  longtable = TRUE,\n  caption = '(`row_counts_summary`)'\n)\n\nsetnames(dt1b, \"x1e\", \"age\")\nbin_cols <- c(\"binA\", \"binB\", \"binC\")\ndt1b[,\n  (bin_cols) := lapply(.SD, function(x) ifelse(x == \"Yes\", 1L, 0L)),\n  .SDcols = bin_cols\n]\ndt1b[age == \"18 to 24\", `:=`(age_num = 21, age_order = 1L)]\ndt1b[age == \"25 to 49\", `:=`(age_num = 42, age_order = 2L)]\ndt1b[age == \"50+\", `:=`(age_num = 57.5, age_order = 3L)]\ndt1b[,\n  age_factor := factor(\n    age,\n    levels = c(\"A\", \"B\", \"C\"),\n    ordered = TRUE\n  )\n]\ncat_cols <- c(\"regA\", \"regB\", \"sex\")\ndt1b[, (cat_cols) := lapply(.SD, as.factor), .SDcols = cat_cols]\n\ndt1b[, a1 := as.integer(binA == 1 & binB == 0 & binC == 0)] # 1,0,0\ndt1b[, a2 := as.integer(binA == 0 & binB == 1 & binC == 0)] # 0,1,0\ndt1b[, a3 := as.integer(binA == 0 & binB == 0 & binC == 1)] # 0,0,1\ndt1b[, a4 := as.integer(binA == 1 & binB == 1 & binC == 0)] # 1,1,0\ndt1b[, a5 := as.integer(binA == 0 & binB == 1 & binC == 1)] # 0,1,1\ndt1b[, a6 := as.integer(binA == 1 & binB == 0 & binC == 1)] # 1,0,1\ndt1b[, a7 := as.integer(binA == 1 & binB == 1 & binC == 1)] # 1,1,1\ndt1b[, a8 := as.integer(binA == 0 & binB == 0 & binC == 0)] # 0,0,0\n\ndt_unbiased <- dt1b[,\n  .(\n    a1 = sum(a1 * np),\n    a2 = sum(a2 * np),\n    a3 = sum(a3 * np),\n    a4 = sum(a4 * np),\n    a5 = sum(a5 * np),\n    a6 = sum(a6 * np),\n    a7 = sum(a7 * np),\n    a8 = sum(a8 * np),\n    Y = sum(binB * np) / sum(np),\n    D = sum(binA * np) / sum(np),\n    total_np = sum(np),\n    age_val = first(age_num),\n    sex = first(sex),\n    regA = first(regA)\n  ),\n  by = .(id, year)\n]\n\nstate_cols <- paste0(\"a\", 1:8)\ndt_unbiased[, combo_count := rowSums(.SD > 0), .SDcols = state_cols]\ndt_8 <- dt_unbiased[combo_count == 8]\ndt_7 <- dt_unbiased[combo_count == 7]\ndt_6 <- dt_unbiased[combo_count == 6]\ndt_5 <- dt_unbiased[combo_count == 5]\ndt_4 <- dt_unbiased[combo_count == 4]\ndt_3 <- dt_unbiased[combo_count == 3]\ndt_2 <- dt_unbiased[combo_count == 2]\ndt_1 <- dt_unbiased[combo_count == 1]\ndt_2plus <- dt_unbiased[combo_count >= 2]\n\nsubset_summary <- dt_unbiased[, .(n_persons = .N), by = combo_count][order(\n  -combo_count\n)]\nknitr::kable(\n  subset_summary,\n  booktabs = TRUE,\n  longtable = TRUE,\n  caption = '(`subset_summary`)'\n)\nprint(paste(\n  \"Number of rows with NA combo_count:\",\n  sum(is.na(dt_unbiased$combo_count))\n))\n\nalert_stats <- summary(dt_unbiased[, .(a1, a2, a3, a4, a5, a6, a7, a8)])\nknitr::kable(\n  alert_stats,\n  booktabs = TRUE,\n  longtable = TRUE,\n  caption = '(`alert_stats`)'\n)\n\ndt_unbiased[,\n  combo_count_robust := rowSums(.SD > 0, na.rm = TRUE),\n  .SDcols = state_cols\n]\n\nalert_stats1a <- as.data.frame(table(dt_unbiased$combo_count_robust)) \n\n# Then pass it to kable\nknitr::kable(\n  alert_stats1a,\n  booktabs = TRUE,\n  longtable = TRUE,\n  caption = '(`alert_stats1a`)'\n)\ntop_ids <- placement_dist[unique_status_rows >= 7, id]\ncomplex_moves <- dt_unbiased[id %in% top_ids]\nprint(complex_moves[, .(id, combo_count, total_np, a1, a2, a4, a5, a7, a8)])\nknitr::kable(\n  complex_moves[, .(id, combo_count, total_np, a1, a2, a4, a5, a7, a8)],\n  booktabs = TRUE,\n  longtable = TRUE,\n  caption = '(`complex_moves`)'\n)\n\nregion_profile <- dcast(\n  dt1b[id %in% top_ids],\n  id + year ~ regA,\n  value.var = \"np\",\n  fun.aggregate = sum\n)\n\ncomplex_subset <- merge(\n  dt_unbiased[\n    id %in% top_ids,\n    .(id, year, combo_count, total_np, a1, a2, a4, a5, a7, a8)\n  ],\n  region_profile,\n  by = c(\"id\", \"year\")\n)\nknitr::kable(\n  complex_subset,\n  booktabs = TRUE,\n  longtable = TRUE,\n  caption = '(`complex_subset`)'\n)\n\ndt_complex_raw <- dt1b[id %in% top_ids]\nregA_counts <- dcast(\n  dt_complex_raw,\n  id + year ~ regA,\n  value.var = \"np\",\n  fun.aggregate = sum\n)\nsetnames(\n  regA_counts,\n  old = setdiff(names(regA_counts), c(\"id\", \"year\")),\n  new = paste0(setdiff(names(regA_counts), c(\"id\", \"year\")), \"_A\")\n)\n\nregB_counts <- dcast(\n  dt_complex_raw,\n  id + year ~ regB,\n  value.var = \"np\",\n  fun.aggregate = sum\n)\nsetnames(\n  regB_counts,\n  old = setdiff(names(regB_counts), c(\"id\", \"year\")),\n  new = paste0(setdiff(names(regB_counts), c(\"id\", \"year\")), \"_B\")\n)\n\ncomplex_subset <- merge(\n  dt_unbiased[\n    id %in% top_ids,\n    .(id, year, combo_count, total_np, a1, a2, a4, a5, a7, a8)\n  ],\n  regA_counts,\n  by = c(\"id\", \"year\"),\n  all.x = TRUE\n)\ncomplex_subset <- merge(\n  complex_subset,\n  regB_counts,\n  by = c(\"id\", \"year\"),\n  all.x = TRUE\n)\n\ncomplex_subset[is.na(complex_subset)] <- as.double(0)\n\nknitr::kable(\n  complex_subset,\n  booktabs = TRUE,\n  longtable = TRUE,\n  caption = '(`complex_subset`)'\n)\n\nall_regions <- c(\"Toronto\", \"Central\", \"Eastern\", \"Western\", \"Northern\")\ndt_complex_raw <- dt1b[id %in% top_ids]\ndt_complex_raw[, regA := factor(regA, levels = all_regions)]\ndt_complex_raw[, regB := factor(regB, levels = all_regions)]\n\nregA_counts <- dcast(\n  dt_complex_raw,\n  id + year ~ regA,\n  value.var = \"np\",\n  fun.aggregate = sum,\n  drop = FALSE\n)\n\nsetnames(regA_counts, old = all_regions, new = paste0(all_regions, \"_A\"))\n\nregB_counts <- dcast(\n  dt_complex_raw,\n  id + year ~ regB,\n  value.var = \"np\",\n  fun.aggregate = sum,\n  drop = FALSE\n)\n\nsetnames(regB_counts, old = all_regions, new = paste0(all_regions, \"_B\"))\n\ncomplex_subset <- dt_unbiased[\n  id %in% top_ids,\n  .(id, year, combo_count, total_np, a1, a2, a4, a5, a7, a8)\n]\n\ncomplex_subset <- merge(\n  complex_subset,\n  regA_counts,\n  by = c(\"id\", \"year\"),\n  all.x = TRUE\n)\ncomplex_subset <- merge(\n  complex_subset,\n  regB_counts,\n  by = c(\"id\", \"year\"),\n  all.x = TRUE\n)\n\ncols_to_fix <- c(paste0(all_regions, \"_A\"), paste0(all_regions, \"_B\"))\ncomplex_subset[,\n  (cols_to_fix) := lapply(.SD, function(x) ifelse(is.na(x), 0, x)),\n  .SDcols = cols_to_fix\n]\n\n# Complex Cases (10 Regional Columns + Possible Alert Status Combinations)\nknitr::kable(\n  complex_subset,\n  booktabs = TRUE,\n  longtable = TRUE,\n  caption = '(`complex_subset`)'\n)\n\ndt_moves_corrected <- dt1b[\n  order(id, year),\n  .(\n    id,\n    year,\n    internal_move = as.integer(regA != regB),\n    external_move = as.integer(regA != shift(regA, type = \"lag\"))\n  ),\n  by = .(id, year)\n]\nregional_volatility <- dt_moves_corrected[,\n  .(\n    total_regional_changes = sum(\n      internal_move == 1 | (external_move == 1 & !is.na(external_move))\n    )\n  ),\n  by = .(id, year)\n]\ndt_unbiased <- merge(\n  dt_unbiased,\n  regional_volatility,\n  by = c(\"id\", \"year\"),\n  all.x = TRUE\n)\nmove_summary <- dt_unbiased[,\n  .(n_persons = .N),\n  by = total_regional_changes\n][order(total_regional_changes)]\nprint(move_summary)\nregion_counts_per_id <- dt1b[,\n  .(\n    unique_regions = list(unique(c(regA, regB)))\n  ),\n  by = .(id, year)\n]\nregion_counts_per_id[, n_regions := sapply(unique_regions, length)]\nmulti_region_ids <- region_counts_per_id[n_regions > 1]\ntotal_multi_region_persons <- nrow(multi_region_ids)\ntotal_unique_persons <- nrow(region_counts_per_id)\n\nprint(paste(\"Total Unique Person-IDs in dataset:\", total_unique_persons))\nprint(paste(\"Number of Person-IDs with >1 region:\", total_multi_region_persons))\nprint(paste(\n  \"Percentage of population moving regions:\",\n  round((total_multi_region_persons / total_unique_persons) * 100, 2),\n  \"%\"\n))\n\nreg_count_id <- table(region_counts_per_id$n_regions)\nknitr::kable(\n  reg_count_id,\n  booktabs = TRUE,\n  longtable = TRUE,\n  caption = '(`reg_count_id`)'\n)\n\ndt1b[,\n  status_combo := case_when(\n    binA == 1 & binB == 0 & binC == 0 ~ \"a1\",\n    binA == 0 & binB == 1 & binC == 0 ~ \"a2\",\n    binA == 0 & binB == 0 & binC == 1 ~ \"a3\",\n    binA == 1 & binB == 1 & binC == 0 ~ \"a4\",\n    binA == 0 & binB == 1 & binC == 1 ~ \"a5\",\n    binA == 1 & binB == 0 & binC == 1 ~ \"a6\",\n    binA == 1 & binB == 1 & binC == 1 ~ \"a7\",\n    binA == 0 & binB == 0 & binC == 0 ~ \"a8\"\n  )\n]\n\ndt1b[, reg_status_key := paste0(regA, \"_\", status_combo)]\ndt_40state <- dcast(\n  dt1b,\n  id + year + sex + age_num + age_order ~ reg_status_key,\n  value.var = \"np\",\n  fun.aggregate = sum,\n  fill = 0\n)\n\nprint(paste(\"Number of columns in the new state-space:\", ncol(dt_40state)))\nhead(dt_40state)\n\nstate_totals <- colSums(dt_40state[, .SD, .SDcols = patterns(\"_a[1-8]\")])\n\nstate_summary <- data.table(\n  state = names(state_totals),\n  total_placements = state_totals\n)[order(-total_placements)]\n\nprint(\"Top Ten Empirical Region-Status combinations:\")\nprint(head(state_summary, 10))\n\nid_counts <- dt_40state[,\n  lapply(.SD, function(x) sum(x > 0)),\n  .SDcols = patterns(\"_a[1-8]\")\n]\n\nid_counts_t <- data.table(\n  state = names(id_counts),\n  count_of_people = as.numeric(id_counts)\n)[order(-count_of_people)]\n\nprint(\"Number of unique individuals who entered each state:\")\nprint(id_counts_t)\n\ndt_40state[, states_visited := rowSums(.SD > 0), .SDcols = patterns(\"_a[1-8]\")]\n\ncomplexity_dist <- dt_40state[, .(n_people = .N), by = states_visited][order(\n  states_visited\n)]\n\nprint(\"How many unique Region-Status states did people visit?\")\nprint(complexity_dist)\n\ndt1b[,\n  status_combo := case_when(\n    binA == 1 & binB == 0 & binC == 0 ~ \"a1\",\n    binA == 0 & binB == 1 & binC == 0 ~ \"a2\",\n    binA == 0 & binB == 0 & binC == 1 ~ \"a3\",\n    binA == 1 & binB == 1 & binC == 0 ~ \"a4\",\n    binA == 0 & binB == 1 & binC == 1 ~ \"a5\",\n    binA == 1 & binB == 0 & binC == 1 ~ \"a6\",\n    binA == 1 & binB == 1 & binC == 1 ~ \"a7\",\n    binA == 0 & binB == 0 & binC == 0 ~ \"a8\"\n  )\n]\n\ndt1b[, reg_status_key := paste0(regA, \"_\", status_combo)]\ndt_40state_yearly <- dcast(\n  dt1b,\n  id + year + sex + age_num ~ reg_status_key,\n  value.var = \"np\",\n  fun.aggregate = sum,\n  fill = 0\n)\n\nyearly_stats <- dt_40state_yearly[,\n  .(\n    unique_ids = uniqueN(id),\n    total_placements = sum(.SD, na.rm = TRUE)\n  ),\n  by = year,\n  .SDcols = patterns(\"_a[1-8]\")\n]\n\nprint(yearly_stats)\n\nsplit_summary <- dt_40state_yearly[,\n  lapply(.SD, sum),\n  by = year,\n  .SDcols = patterns(\"_a[1-8]\")\n]\n\nprint(\"First few rows of 2023 data:\")\nhead(dt_40state_yearly[year == 2023])\ndt_40state_yearly[,\n  combinations_this_year := rowSums(.SD > 0),\n  .SDcols = patterns(\"_a[1-8]\")\n]\ntable(dt_40state_yearly$year, dt_40state_yearly$combinations_this_year)\n\nid_counts_yearly <- dt_40state_yearly[,\n  lapply(.SD, function(x) sum(x > 0)),\n  by = year,\n  .SDcols = patterns(\"_a[1-8]\")\n]\n\nid_counts_long <- melt(\n  id_counts_yearly,\n  id.vars = \"year\",\n  variable.name = \"state\",\n  value.name = \"person_count\"\n)\n\nid_counts_long <- id_counts_long[order(year, -person_count)]\nprint(\"Top 5 most frequent Region-Status states per year:\")\nprint(id_counts_long[, head(.SD, 5), by = year])\nempty_states <- id_counts_long[,\n  .(total_across_years = sum(person_count)),\n  by = state\n][total_across_years == 0]\n\nprint(\"States with zero occupancy (these won't help the DoubleML):\")\nprint(empty_states$state)\nreg_summary <- dt1b[,\n  .(\n    reg_count = uniqueN(c(regA, regB)),\n    regC = paste(sort(unique(c(regA, regB))), collapse = \" + \")\n  ),\n  by = .(id, year)\n]\n\nstatus_summary <- dcast(\n  dt1b,\n  id + year ~ status_combo,\n  value.var = \"np\",\n  fun.aggregate = sum,\n  fill = 0\n)\n\ndt_final_complex <- merge(status_summary, reg_summary, by = c(\"id\", \"year\"))\n\ndemo_info <- dt1b[,\n  .(\n    sex = first(sex),\n    age_num = first(age_num)\n  ),\n  by = .(id, year)\n]\n\ndt_final_complex <- merge(dt_final_complex, demo_info, by = c(\"id\", \"year\"))\n\nprint(head(dt_final_complex))\n\nregC_stats <- dt_final_complex[, .(n_persons = .N), by = regC][order(\n  -n_persons\n)]\nprint(regC_stats)\n\nregC_yearly_counts <- dt_final_complex[, .(n = .N), by = .(regC, year)]\n\nregC_stats_wide <- dcast(\n  regC_yearly_counts,\n  regC ~ year,\n  value.var = \"n\",\n  fill = 0\n)\n\nyear_cols <- setdiff(names(regC_stats_wide), \"regC\")\nnew_t_names <- paste0(\"t\", seq_along(year_cols))\nsetnames(regC_stats_wide, old = year_cols, new = new_t_names)\n\nregC_stats_wide[, n_persons := rowSums(.SD), .SDcols = new_t_names]\n\nsetcolorder(regC_stats_wide, c(\"regC\", \"n_persons\", new_t_names))\nregC_stats_wide <- regC_stats_wide[order(-n_persons)]\n\nprint(regC_stats_wide)\n\ndemog_counts <- dt_final_complex[, .(n = .N), by = .(regC, year, sex)]\n\ndemog_wide <- dcast(demog_counts, regC ~ year + sex, value.var = \"n\", fill = 0)\n\nunique_years <- sort(unique(demog_counts$year))\n\nfor (i in seq_along(unique_years)) {\n  year_val <- unique_years[i]\n  suffix <- letters[i]\n  setnames(\n    demog_wide,\n    old = paste0(year_val, \"_Male\"),\n    new = paste0(\"g1\", suffix),\n    skip_absent = TRUE\n  )\n  setnames(\n    demog_wide,\n    old = paste0(year_val, \"_Female\"),\n    new = paste0(\"g2\", suffix),\n    skip_absent = TRUE\n  )\n}\n\ndemog_wide[, t1 := g1a + g2a]\ndemog_wide[, t2 := g1b + g2b]\ndemog_wide[, t3 := g1c + g2c]\n\ndemog_wide[, n_persons := t1 + t2 + t3]\n\nsetcolorder(\n  demog_wide,\n  c(\n    \"regC\",\n    \"n_persons\",\n    \"t1\",\n    \"t2\",\n    \"t3\",\n    \"g1a\",\n    \"g1b\",\n    \"g1c\",\n    \"g2a\",\n    \"g2b\",\n    \"g2c\"\n  )\n)\nregC_demog_stats <- demog_wide[order(-n_persons)]\n\nprint(regC_demog_stats)\n\nknitr::kable(res_pool, digits = 4, caption = \"Pooled IRM DoubleML (2023–2025)\")\nknitr::kable(\n  res_by_year,\n  digits = 4,\n  caption = \"Yearly IRM DoubleML (2023/2024/2025)\"\n)\nknitr::kable(\n  res_pool,\n  booktabs = TRUE,\n  longtable = TRUE,\n  digits = 4,\n  caption = \"Pooled IRM DoubleML (2023–2025)\"\n)\nknitr::kable(\n  res_by_year,\n  booktabs = TRUE,\n  longtable = TRUE,\n  digits = 4,\n  caption = \"IRM DoubleML (2023/2024/2025)\"\n)\n\ndt1c <- as.data.table(dataframe_original1b)\nsetnames(\n  dt1c,\n  old = c(\n    \"x1a\",\n    \"unique_individual_id\",\n    \"x1b\",\n    \"x1c\",\n    \"x1d\",\n    \"x1e\",\n    \"x1f\",\n    \"x1g\",\n    \"x1h\",\n    \"x1i\"\n  ),\n  new = c(\"year\", \"id\", \"regA\", \"regB\", \"sex\", \"age\", \"bA\", \"bB\", \"bC\", \"np\"),\n  skip_absent = TRUE\n)\n\ndt1c[, `:=`(\n  bA = as.integer(bA == \"Yes\"),\n  bB = as.integer(bB == \"Yes\"),\n  bC = as.integer(bC == \"Yes\"),\n  age_n = fcase(\n    age == \"18 to 24\" , 21   ,\n    age == \"25 to 49\" , 42   ,\n    age == \"50+\"      , 57.5\n  )\n)]\n\ndt1c[,\n  combo := fcase(\n    bA == 1 & bB == 0 & bC == 0 , \"a1\" ,\n    bA == 0 & bB == 1 & bC == 0 , \"a2\" ,\n    bA == 1 & bB == 1 & bC == 0 , \"a4\" ,\n    bA == 0 & bB == 1 & bC == 1 , \"a5\" ,\n    bA == 1 & bB == 1 & bC == 1 , \"a7\" ,\n    bA == 0 & bB == 0 & bC == 0 , \"a8\"\n  )\n]\n\n# person-year: alert-state intensity via 2^3 = 8 possible outcomes (a1-a8) where two (a3 and a6) were not observed empirically\norc <- dt1c[,\n  .(\n    a1 = sum((combo == \"a1\") * np, na.rm = TRUE),\n    a2 = sum((combo == \"a2\") * np, na.rm = TRUE),\n    a4 = sum((combo == \"a4\") * np, na.rm = TRUE),\n    a5 = sum((combo == \"a5\") * np, na.rm = TRUE),\n    a7 = sum((combo == \"a7\") * np, na.rm = TRUE),\n    a8 = sum((combo == \"a8\") * np, na.rm = TRUE),\n    np = sum(np),\n    rg = uniqueN(c(regA, regB)),\n    rc = paste(sort(unique(c(regA, regB))), collapse = \" + \"),\n    yr = first(year),\n    sg = first(sex),\n    ag = first(age_n)\n  ),\n  by = id\n]\n\nkeyz <- c(\"a1\", \"a2\", \"a4\", \"a5\", \"a7\", \"a8\")\norc[, ac := rowSums(.SD > 0), .SDcols = keyz]\n\n# 6. VOLATILITY (v_moves): placement transfers/shifts within the person-year sequence for vm\nmoves <- dt1c[\n  order(id),\n  .(\n    vm = sum((regA != regB) | (regA != shift(regA) & !is.na(shift(regA))))\n  ),\n  by = id\n]\n\norc <- merge(orc, moves, by = \"id\")\n\nsetcolorder(\n  orc,\n  c(\n    \"yr\",\n    \"ag\",\n    \"sg\",\n    \"np\",\n    \"ac\",\n    \"rg\",\n    \"vm\",\n    \"a1\",\n    \"a2\",\n    \"a4\",\n    \"a5\",\n    \"a7\",\n    \"a8\",\n    \"id\",\n    \"rc\"\n  )\n)\n\nprint(orc[ac > 3][order(-ac)][1:10])\nprint(paste(\"Zero day rows:\", nrow(orc[np == 0])))\n\norc[, id := .I]\norc[, sg := ifelse(sg == \"Male\", 1, 2)]\n\n\n# Xbar and SD for complexity and volatility by year and gender\nstatz <- orc[,\n  .(\n    n = .N,\n    xA = round(mean(ac, na.rm = TRUE), 2),\n    sA = round(sd(ac, na.rm = TRUE), 2),\n    xB = round(mean(vm, na.rm = TRUE), 2),\n    sB = round(sd(vm, na.rm = TRUE), 2)\n  ),\n  by = .(yr, sg)\n]\n\nstatz <- statz[order(yr, sg)]\nprint(\"--- Summary Statistics for Methods Section ---\")\nprint(statz)\n\norc[,\n  agc := fcase(\n    ag == 21 , \"21\" , ag == 42 , \"42\" , ag == 57.5 , \"57.5\"\n  )\n]\n\nlibrary(data.table)\nlibrary(lme4)\nlibrary(glmmTMB)\nlibrary(DHARMa)\nlibrary(cobalt)\nlibrary(DoubleML)\nlibrary(mlr3)\nlibrary(mlr3learners)\nlibrary(Hmisc) # weighted variance/sd\n# weighted mean: sum(value * weight) / sum(weight)\n# weighted sd: sq rt of weighted variance\n\nstatz1a <- orc[,\n  .(\n    n = .N,\n    xA = round(wtd.mean(ac, weights = np), 2),\n    sA = round(sqrt(wtd.var(ac, weights = np)), 2),\n    xB = round(wtd.mean(vm, weights = np), 2),\n    sB = round(sqrt(wtd.var(vm, weights = np)), 2)\n  ),\n  by = .(yr, sg, agc, rc)\n]\nstatz1a[is.na(sA), sA := mean(sB)]\nstatz1a[is.na(sB), sB := mean(sB)]\n\nprint(statz1a[order(yr, agc, sg, n, xA, xB, sA, sB, rc)])\n# year, age, gender, region\nstatz1a <- statz1a[order(yr, agc, sg, n, xA, xB, sA, sB, rc)]\nprint(\"--- Detailed Summary Statistics (By Year, Demographics, and Region) ---\")\nprint(head(statz1a, 30))\n# paths by volume per year\nrpvy <- statz1a[, .SD[head(order(-n), 15)], by = yr]\nprint(rpvy)\n\norc[, agc := NULL]\n\norc[,\n  ag := fcase(\n    ag == 21   , \"21\"   ,\n    ag == 42   , \"42\"   ,\n    ag == 57.5 , \"57.5\"\n  )\n]\n\norc[, rc := as.factor(rc)]\norc[, ag := factor(ag, levels = c(\"21\", \"42\", \"57.5\"), ordered = TRUE)]\norc[, sg := factor(sg, levels = c(1, 2), labels = c(\"M\", \"F\"))]\norc[, yr := factor(yr, levels = sort(unique(yr)), ordered = TRUE)]\n# data types\nstr(orc[, .(yr, ag, sg, rc)])\norc[, treat := as.integer(ac >= 2)]\nm.out <- matchit(\n  treat ~ ag + sg + yr,\n  data = orc,\n  method = \"nearest\",\n  distance = \"glm\",\n  weights = orc$np\n)\n\norc_matched <- match.data(m.out)\n\n# fit of weighted poisson GLMM  'weights' (matching weights) via MatchIt\nmodel_final <- glmer(\n  vm ~ treat + ag + sg + yr + (1 | rc),\n  data = orc_matched,\n  family = poisson(link = \"log\"),\n  weights = weights\n)\n# poisson model fit (matched sample)\nmodel_final <- glmer(\n  vm ~ treat + ag + sg + yr + (1 | rc),\n  data = orc_matched,\n  family = poisson(link = \"log\"),\n  weights = weights\n)\nsummary(model_final)\n#  effect sizes (Incidence Rate Ratio) from log-odds\nresults_table <- exp(fixef(model_final))\nprint(results_table)\n\nlibrary(DHARMa)\nsim_res <- simulateResiduals(model_final)\nplot(sim_res)\ntestDispersion(sim_res)\ntestZeroInflation(sim_res)\nlibrary(glmmTMB)\nmodel_final_thesis <- glmmTMB(\n  vm ~ treat + ag + sg + yr + (1 | rc),\n  data = orc_matched,\n  family = nbinom2,\n  weights = weights,\n  control = glmmTMBControl(optimizer = optim, optArgs = list(method = \"BFGS\"))\n)\n\nsummary(model_final_thesis)\n\nfix_eff <- summary(model_final_thesis)$coefficients$cond\n\nresults_final <- data.frame(\n  Variable = rownames(fix_eff),\n  IRR = exp(fix_eff[, \"Estimate\"]),\n  Lower_CI = exp(fix_eff[, \"Estimate\"] - 1.96 * fix_eff[, \"Std. Error\"]),\n  Upper_CI = exp(fix_eff[, \"Estimate\"] + 1.96 * fix_eff[, \"Std. Error\"]),\n  P_Value = fix_eff[, \"Pr(>|z|)\"]\n)\n\nprint(results_final)\nsim_res1b <- simulateResiduals(model_final_thesis, n = 5000)\nplot(sim_res1b)\ntestDispersion(sim_res1b)\ntestZeroInflation(sim_res1b)\n# naive weighted mean comparison to double-check the 33% increase; close to the IRR ?:!\nlibrary(weights)\nwtd.mean(\n  orc_matched$vm[orc_matched$treat == 1],\n  weights = orc_matched$weights[orc_matched$treat == 1]\n)\nwtd.mean(\n  orc_matched$vm[orc_matched$treat == 0],\n  weights = orc_matched$weights[orc_matched$treat == 0]\n)\nplot(sim_res1b)\ntestDispersion(sim_res1b)\ntestZeroInflation(sim_res1b)\n\nlibrary(cobalt)\n\nlove_plot <- love.plot(\n  m.out,\n  binary = \"std\",\n  thresholds = c(m = .1),\n  var.order = \"unadjusted\",\n  abs = TRUE,\n  colors = c(\"red\", \"blue\"),\n  shapes = c(\"circle\", \"triangle\"),\n  sample.names = c(\"Original\", \"Matched\"),\n  stars = \"std\"\n)\n\nprint(love_plot)\n\nbal_table <- bal.tab(m.out, un = TRUE)\nprint(bal_table)\nlove.plot(\n  m.out,\n  binary = \"std\",\n  stats = \"m\",\n  thresholds = c(m = .1),\n  abs = TRUE,\n  line = TRUE,\n  sample.names = c(\"Original (Pre-Match)\", \"Matched (Final Sample)\"),\n  colors = c(\"#d62728\", \"#1f77b4\"),\n  shapes = c(21, 24),\n  title = \"Covariate Balance Across Groups\",\n  xlab = \"Absolute Standardized Mean Differences\",\n)\n\ndml_data <- as.data.frame(orc_matched)\ndml_data$sg <- as.numeric(dml_data$sg)\ndml_data$ag <- as.numeric(dml_data$ag)\ndml_data$yr <- as.numeric(dml_data$yr)\n\ndata_dml_obj = double_ml_data_from_data_frame(\n  dml_data,\n  y_col = \"vm\",\n  d_cols = \"treat\",\n  x_cols = c(\"ag\", \"sg\", \"yr\")\n)\n\nl_ranger = lrn(\"regr.ranger\", num.trees = 500, max.depth = 5)\n\ndml_model = DoubleMLPLR$new(\n  data_dml_obj,\n  ml_l = l_ranger,\n  ml_m = l_ranger,\n  n_folds = 3\n) #  l = target y learner ; m = treatment d learner\n\ndml_model$fit()\nprint(dml_model$summary())\n\ndml_matrix_data <- model.matrix(\n  ~ vm + treat + ag + sg + yr + rc - 1,\n  data = orc_matched\n)\ndml_df <- as.data.frame(dml_matrix_data)\ncolnames(dml_df) <- make.names(colnames(dml_df))\n\ndata_dml_adj = double_ml_data_from_data_frame(\n  dml_df,\n  y_col = \"vm\",\n  d_cols = \"treat\",\n  x_cols = setdiff(colnames(dml_df), c(\"vm\", \"treat\"))\n)\n\nl_ranger = lrn(\"regr.ranger\", num.trees = 500, max.depth = 5)\n\ndml_model_adj = DoubleMLPLR$new(\n  data_dml_adj,\n  ml_l = l_ranger,\n  ml_m = l_ranger,\n  n_folds = 3\n)\n\ndml_model_adj$fit(store_predictions = TRUE)\n\ndml_preds_final <- dml_model_adj$predictions$ml_l[, 1, 1]\n\nprint(paste(\"DML Predictions Count:\", length(dml_preds_final)))\n\nglmm_preds_final <- predict(model_final_thesis, type = \"response\")\n\nplot_data <- data.frame(\n  Actual = as.numeric(orc_matched$vm),\n  GLMM = as.numeric(glmm_preds_final),\n  DML = as.numeric(dml_preds_final)\n)\n\nggplot(plot_data) +\n  geom_density(aes(x = GLMM, fill = \"GLMM (Parametric)\"), alpha = 0.4) +\n  geom_density(aes(x = DML, fill = \"DML (Machine Learning)\"), alpha = 0.4) +\n  scale_x_log10(labels = scales::comma) +\n  labs(\n    title = \"Comparison of Predicted Values (Log Scale)\",\n    subtitle = \"Revealing the distribution of low-probability GLMM predictions\",\n    x = \"Predicted Moves (Log10 Scale)\",\n    y = \"Density\",\n    fill = \"Model Type\"\n  ) +\n  theme_minimal() # log10 transformation for distribution of very small GLMM values\nmse_glmm <- mean((plot_data$Actual - plot_data$GLMM)^2)\nmse_dml <- mean((plot_data$Actual - plot_data$DML)^2)\n\ncat(\"\\n--- Initial Results ---\\n\")\nprint(dml_model_adj$summary())\ncat(\"GLMM MSE:\", round(mse_glmm, 6), \"\\n\")\ncat(\"DML MSE: \", round(mse_dml, 6), \"\\n\")\n\nsummary(orc_matched$weights)\ncat(\"Matching weight distribution:\\n\")\nprint(table(orc_matched$weights))\ncat(\"\\nBy treatment group:\\n\")\nprint(aggregate(weights ~ treat, data = orc_matched, FUN = summary))\ncat(\"\\nSample sizes by treatment:\\n\")\nprint(table(orc_matched$treat))\ndml_data_clustered <- DoubleMLClusterData$new(\n  data = as.data.frame(orc_matched),\n  y_col = \"vm\",\n  d_cols = \"treat\",\n  x_cols = c(\"ag\", \"sg\", \"yr\", \"rc\"),\n  cluster_cols = \"id\"\n)\n\nset.seed(42569872)\ndml_clustered <- DoubleMLPLR$new(\n  dml_data_clustered,\n  ml_l = lrn(\"regr.ranger\", num.trees = 500, max.depth = 5),\n  ml_m = lrn(\"regr.ranger\", num.trees = 500, max.depth = 5),\n  n_folds = 3\n)\n\ndml_clustered$fit()\nprint(dml_clustered$summary())\n\nlibrary(sandwich)\nlibrary(lmtest)\ndml_data_region_clustered <- DoubleMLClusterData$new(\n  data = as.data.frame(orc_matched),\n  y_col = \"vm\",\n  d_cols = \"treat\",\n  x_cols = c(\"ag\", \"sg\"),\n  cluster_cols = c(\"rc\", \"yr\")\n)\n\nset.seed(2764389)\ndml_region_clustered <- DoubleMLPLR$new(\n  dml_data_region_clustered,\n  ml_l = lrn(\"regr.ranger\", num.trees = 500, max.depth = 5),\n  ml_m = lrn(\"regr.ranger\", num.trees = 500, max.depth = 5),\n  n_folds = 3\n)\n\ndml_region_clustered$fit()\nprint(dml_region_clustered$summary())\n\ndml_data_region <- DoubleMLClusterData$new(\n  data = as.data.frame(orc_matched),\n  y_col = \"vm\",\n  d_cols = \"treat\",\n  x_cols = c(\"ag\", \"sg\", \"yr\"),\n  cluster_cols = \"rc\"\n)\n\nset.seed(6450835)\ndml_region <- DoubleMLPLR$new(\n  dml_data_region,\n  ml_l = lrn(\"regr.ranger\", num.trees = 500, max.depth = 5),\n  ml_m = lrn(\"regr.ranger\", num.trees = 500, max.depth = 5),\n  n_folds = 3\n)\n\ndml_region$fit()\nprint(dml_region$summary())\n\ndml_data_yr <- DoubleMLClusterData$new(\n  data = as.data.frame(orc_matched),\n  y_col = \"vm\",\n  d_cols = \"treat\",\n  x_cols = c(\"ag\", \"sg\", \"rc\"),\n  cluster_cols = \"yr\"\n)\n\nset.seed(69543)\ndml_yearz <- DoubleMLPLR$new(\n  dml_data_yr,\n  ml_l = lrn(\"regr.ranger\", num.trees = 500, max.depth = 5),\n  ml_m = lrn(\"regr.ranger\", num.trees = 500, max.depth = 5),\n  n_folds = 3\n)\n\ndml_yearz$fit()\nprint(dml_yearz$summary())\n\n\ndml_data_yrID <- DoubleMLClusterData$new(\n  data = as.data.frame(orc_matched),\n  y_col = \"vm\",\n  d_cols = \"treat\",\n  x_cols = c(\"ag\", \"sg\", \"rc\", \"id\"),\n  cluster_cols = \"yr\"\n)\n\nset.seed(2468176)\ndml_yearzID <- DoubleMLPLR$new(\n  dml_data_yrID,\n  ml_l = lrn(\"regr.ranger\", num.trees = 500, max.depth = 5),\n  ml_m = lrn(\"regr.ranger\", num.trees = 500, max.depth = 5),\n  n_folds = 3\n)\n\ndml_yearzID$fit()\nprint(dml_yearzID$summary())\n\ndml_data_IDz <- DoubleMLClusterData$new(\n  data = as.data.frame(orc_matched),\n  y_col = \"vm\",\n  d_cols = \"treat\",\n  x_cols = c(\n    \"ag\",\n    \"sg\",\n    \"rc\",\n    \"yr\",\n    \"subclass\",\n    \"id\",\n    \"a1\",\n    \"a2\",\n    \"a4\",\n    \"a5\",\n    \"a7\",\n    \"a8\"\n  ),\n  cluster_cols = \"distance\"\n)\n\nset.seed(4568937)\ndml_IDz <- DoubleMLPLR$new(\n  dml_data_IDz,\n  ml_l = lrn(\"regr.ranger\", num.trees = 500, max.depth = 5),\n  ml_m = lrn(\"regr.ranger\", num.trees = 500, max.depth = 5),\n  n_folds = 3\n)\n\ndml_IDz$fit()\nprint(dml_IDz$summary())\nml_g <- lrn(\"regr.ranger\", num.trees = 500, max.depth = 5)\nml_m <- lrn(\"classif.ranger\", num.trees = 500, max.depth = 5)\nx_cols_all <- c(\"ag\", \"sg\", \"rc\", \"yr\", \"a1\", \"a2\", \"a4\", \"a5\", \"a7\", \"a8\")\norc_matched[,\n  (c(\"sg\", \"rc\", \"yr\")) := lapply(.SD, as.factor),\n  .SDcols = c(\"sg\", \"rc\", \"yr\")\n]\n\nrun_dml_analysis <- function(data, x_cols, tag, cluster_var) {\n  dml_data <- DoubleMLClusterData$new(\n    data = as.data.frame(data),\n    y_col = \"vm\",\n    d_cols = \"treat\",\n    x_cols = x_cols,\n    cluster_cols = cluster_var\n  )\n\n  set.seed(117504871)\n  obj_ate <- DoubleMLIRM$new(\n    dml_data,\n    ml_g = ml_g,\n    ml_m = ml_m,\n    n_folds = 3,\n    score = \"ATE\"\n  )\n  obj_ate$fit()\n  set.seed(16254911)\n  obj_atte <- DoubleMLIRM$new(\n    dml_data,\n    ml_g = ml_g,\n    ml_m = ml_m,\n    n_folds = 3,\n    score = \"ATTE\"\n  )\n  obj_atte$fit()\n\n  extract <- function(obj, est) {\n    ci <- obj$confint(level = 0.95)\n    data.table(\n      method = paste0(\"Clustered by \", cluster_var),\n      group = tag,\n      estimand = est,\n      effect = as.numeric(obj$coef),\n      se = as.numeric(obj$se),\n      p_value = as.numeric(obj$pval),\n      ci_low = as.numeric(ci[1, 1]),\n      ci_high = as.numeric(ci[1, 2])\n    )\n  }\n  return(rbind(extract(obj_ate, \"ATE\"), extract(obj_atte, \"ATTE\")))\n}\n\nres_pool_ID <- run_dml_analysis(orc_matched, x_cols_all, \"Pooled\", \"id\")\n\nyears <- sort(unique(orc_matched$yr))\nx_cols_yearly <- setdiff(x_cols_all, \"yr\")\n\nres_year_ID <- rbindlist(lapply(years, function(yy) {\n  run_dml_analysis(orc_matched[yr == yy], x_cols_yearly, as.character(yy), \"id\")\n}))\nres_pool_SUB <- run_dml_analysis(orc_matched, x_cols_all, \"Pooled\", \"subclass\")\n\nres_year_SUB <- rbindlist(lapply(years, function(yy) {\n  run_dml_analysis(\n    orc_matched[yr == yy],\n    x_cols_yearly,\n    as.character(yy),\n    \"subclass\"\n  )\n}))\n\nfinal_comparison_pool <- rbind(res_pool_ID, res_pool_SUB)\nfinal_comparison_year <- rbind(res_year_ID, res_year_SUB)\n\nknitr::kable(\n  final_comparison_pool,\n  digits = 4,\n  caption = \"Pooled: ID vs Subclass Clustering\"\n)\nknitr::kable(\n  final_comparison_year,\n  digits = 4,\n  caption = \"Yearly: ID vs Subclass Clustering\"\n)\n\nlibrary(DHARMa)\n\nrun_dml_extended <- function(data, x_cols, tag, cluster_var) {\n  dml_data <- DoubleMLClusterData$new(\n    data = as.data.frame(data),\n    y_col = \"vm\",\n    d_cols = \"treat\",\n    x_cols = x_cols,\n    cluster_cols = cluster_var\n  )\n\n  set.seed(68235576)\n  obj_ate <- DoubleMLIRM$new(dml_data, ml_g = ml_g, ml_m = ml_m, n_folds = 3)\n  obj_ate$fit(store_predictions = TRUE)\n  preds_g0 <- obj_ate$predictions$ml_g0[, 1, 1]\n  preds_g1 <- obj_ate$predictions$ml_g1[, 1, 1]\n  dml_fitted <- ifelse(data$treat == 1, preds_g1, preds_g0)\n  current_mse <- mean((data$vm - dml_fitted)^2)\n\n  set.seed(65196489)\n  sim_response <- replicate(250, rpois(length(dml_fitted), dml_fitted))\n  dharma_res <- createDHARMa(\n    simulatedResponse = sim_response,\n    observedResponse = data$vm,\n    fittedPredictedResponse = dml_fitted,\n    integerResponse = TRUE\n  )\n  ci <- obj_ate$confint(level = 0.95)\n  res_table <- data.table(\n    method = paste0(\"Clustered by \", cluster_var),\n    group = tag,\n    effect = as.numeric(obj_ate$coef),\n    se = as.numeric(obj_ate$se),\n    p_value = as.numeric(obj_ate$pval),\n    mse = current_mse,\n    ci_low = as.numeric(ci[1, 1]),\n    ci_high = as.numeric(ci[1, 2])\n  )\n\n  return(list(table = res_table, dharma = dharma_res, fitted = dml_fitted))\n}\n\nml_g <- lrn(\"regr.ranger\", num.trees = 500, max.depth = 5)\nml_m <- lrn(\"classif.ranger\", num.trees = 500, max.depth = 5)\n\npooled_analysis_SUB <- run_dml_extended(\n  orc_matched,\n  x_cols_all,\n  \"Pooled\",\n  \"subclass\"\n)\n\ncat(\"\\n--- DML Model Summary (Clustered by Subclass) ---\\n\")\nprint(pooled_analysis_SUB$table)\n\ncat(\"\\n--- DHARMa Diagnostics ---\\n\")\nplot(pooled_analysis_SUB$dharma)\ntestOutliers(pooled_analysis_SUB$dharma, type = \"bootstrap\")\ntestDispersion(pooled_analysis_SUB$dharma)\ntestZeroInflation(pooled_analysis_SUB$dharma)\n\ncat(\"\\n--- Model Performance Comparison ---\\n\")\ncat(\"GLMM MSE:\", round(mse_glmm, 6), \"\\n\")\ncat(\"DML MSE: \", round(pooled_analysis_SUB$table$mse, 6), \"\\n\")\n\n\nml_g <- lrn(\"regr.ranger\", num.trees = 500, max.depth = 5)\nml_m <- lrn(\"classif.ranger\", num.trees = 500, max.depth = 5)\nx_cols_all <- c(\"ag\", \"sg\", \"rc\", \"yr\", \"a1\", \"a2\", \"a4\", \"a5\", \"a7\", \"a8\")\nx_cols_with_dist <- c(x_cols_all, \"distance\")\nyears <- sort(unique(orc_matched$yr))\n\nrun_dml_stable <- function(data, x_cols, tag, cluster_var) {\n  dml_data <- DoubleMLClusterData$new(\n    data = as.data.frame(data),\n    y_col = \"vm\",\n    d_cols = \"treat\",\n    x_cols = x_cols,\n    cluster_cols = cluster_var\n  )\n\n  set.seed(54893769)\n  obj_ate <- DoubleMLIRM$new(\n    dml_data,\n    ml_g = ml_g,\n    ml_m = ml_m,\n    n_folds = 3,\n    score = \"ATE\"\n  )$fit(store_predictions = TRUE)\n  set.seed(6549875)\n  obj_atte <- DoubleMLIRM$new(\n    dml_data,\n    ml_g = ml_g,\n    ml_m = ml_m,\n    n_folds = 3,\n    score = \"ATTE\"\n  )$fit(store_predictions = TRUE)\n\n  # mse\n  preds_g0 <- obj_ate$predictions$ml_g0[, 1, 1]\n  preds_g1 <- obj_ate$predictions$ml_g1[, 1, 1]\n  dml_fitted <- ifelse(data$treat == 1, preds_g1, preds_g0)\n  calc_mse <- mean((data$vm - dml_fitted)^2)\n\n  extract <- function(obj, est) {\n    ci <- obj$confint(level = 0.95)\n    data.table(\n      method = paste0(\"Clustered by \", cluster_var),\n      group = tag,\n      estimand = est,\n      effect = as.numeric(obj$coef),\n      se = as.numeric(obj$se),\n      p_value = as.numeric(obj$pval),\n      mse = calc_mse,\n      ci_low = as.numeric(ci[1, 1]),\n      ci_high = as.numeric(ci[1, 2])\n    )\n  }\n  return(rbind(extract(obj_ate, \"ATE\"), extract(obj_atte, \"ATTE\")))\n}\n\nall_results_list <- list()\n\nfor (yy in years) {\n  x_yearly <- setdiff(x_cols_all, \"yr\")\n  all_results_list[[paste0(\"ID_\", yy)]] <- run_dml_stable(\n    orc_matched[yr == yy],\n    x_yearly,\n    as.character(yy),\n    \"id\"\n  )\n  all_results_list[[paste0(\"SUB_\", yy)]] <- run_dml_stable(\n    orc_matched[yr == yy],\n    x_yearly,\n    as.character(yy),\n    \"subclass\"\n  )\n}\n\nall_results_list[[\"Pool_23_25_ID\"]] <- run_dml_stable(\n  orc_matched,\n  x_cols_all,\n  \"Pool (23-25)\",\n  \"id\"\n)\nall_results_list[[\"Pool_23_25_SUB\"]] <- run_dml_stable(\n  orc_matched,\n  x_cols_all,\n  \"Pool (23-25)\",\n  \"subclass\"\n)\nall_results_list[[\"Pool_23_24_SUB\"]] <- run_dml_stable(\n  orc_matched[yr %in% c(\"2023\", \"2024\")],\n  x_cols_all,\n  \"Pool (23-24)\",\n  \"subclass\"\n)\nall_results_list[[\"Pool_24_25_SUB\"]] <- run_dml_stable(\n  orc_matched[yr %in% c(\"2024\", \"2025\")],\n  x_cols_all,\n  \"Pool (24-25)\",\n  \"subclass\"\n)\n\nall_results_list[[\"Pool_Dist_Adj\"]] <- run_dml_stable(\n  orc_matched,\n  x_cols_with_dist,\n  \"Pool (Dist-Adj)\",\n  \"subclass\"\n)\n\nm_results <- rbindlist(all_results_list, fill = TRUE)\n\nm_results[, t_stat := abs(effect / se)]\nm_results[, df := 1000] # DF for SEs\nm_results[, RV := round(t_stat / sqrt(df), 4)]\nm_results[,\n  sig := cut(\n    p_value,\n    breaks = c(-Inf, 0.01, 0.05, 0.1, Inf),\n    label = c(\"***\", \"**\", \"*\", \"\")\n  )\n]\n\nknitr::kable(\n  m_results[\n    order(group, method),\n    .(group, method, estimand, effect, se, sig, RV, mse)\n  ],\n  digits = 4,\n  caption = \"Final Consolidated DML Results\"\n)\n\nplot_data1b <- copy(m_results)\nplot_data1b[,\n  group := factor(\n    group,\n    levels = rev(c(\n      as.character(years),\n      \"Pool (23-24)\",\n      \"Pool (24-25)\",\n      \"Pool (23-25)\",\n      \"Pool (Dist-Adj)\"\n    ))\n  )\n]\n\nggplot(plot_data1b, aes(x = effect, y = group, color = method)) +\n  geom_vline(xintercept = 0, linetype = \"dashed\", alpha = 0.5) +\n  geom_errorbarh(\n    aes(xmin = ci_low, xmax = ci_high),\n    height = 0.3,\n    position = position_dodge(width = 0.6)\n  ) +\n  geom_point(position = position_dodge(width = 0.6), size = 3) +\n  facet_wrap(~estimand) +\n  scale_color_brewer(palette = \"Set1\") +\n  labs(\n    title = \"DMLIRM Effect Stability\",\n    x = \"Average Policy Effects of Treatment Variable\",\n    y = \" Computational Model\"\n  ) +\n  theme_minimal()\nset.seed(5469257)\nm.out1a <- matchit(\n  treat ~ ag + sg + yr,\n  data = orc,\n  method = \"nearest\",\n  distance = \"glm\",\n)\n\norc_matched1b <- match.data(m.out1a)\n\nlove_plot1b <- love.plot(\n  m.out1a,\n  binary = \"std\",\n  thresholds = c(m = .1),\n  abs = TRUE,\n  stars = \"std\",\n  line = TRUE,\n  sample.names = c(\"Original (Pre-Match)\", \"Matched (Final Sample)\"),\n  colors = c(\"#d62728\", \"#1f77b4\"),\n  title = \"Covariate Balance\"\n)\nprint(love_plot1b)\n\nmodel_final_thesis1b <- glmmTMB(\n  vm ~ treat + ag + sg + yr + (1 | rc),\n  data = orc_matched1b,\n  family = nbinom2,\n  weights = weights,\n  control = glmmTMBControl(optimizer = optim, optArgs = list(method = \"BFGS\"))\n)\nfix_eff1b <- summary(model_final_thesis1b)$coefficients$cond\nresults_final1b <- data.frame(\n  Variable = rownames(fix_eff1b),\n  IRR = exp(fix_eff1b[, \"Estimate\"]),\n  P_Value = fix_eff1b[, \"Pr(>|z|)\"]\n)\nprint(results_final1b)\n\n# DML robustness test confirms the GLMM via non-linear RF ?:!\ndml_data1b <- copy(orc_matched1b)\ndml_data1b[, `:=`(\n  sg = as.numeric(sg),\n  ag = as.numeric(ag),\n  yr = as.numeric(yr)\n)]\n\ndata_dml_obj1b = double_ml_data_from_data_frame(\n  as.data.frame(dml_data1b),\n  y_col = \"vm\",\n  d_cols = \"treat\",\n  x_cols = c(\"ag\", \"sg\", \"yr\")\n)\n\nl_ranger1b = lrn(\"regr.ranger\", num.trees = 500, max.depth = 5) # nuisance param\ndml_model1b = DoubleMLPLR$new(\n  data_dml_obj1b,\n  ml_l = l_ranger1b,\n  ml_m = l_ranger1b,\n  n_folds = 3\n)\ndml_model1b$fit()\nprint(dml_model1b$summary())\n\nfit_raw <- glm(vm ~ treat, data = orc, family = poisson()) # baseline\nate_raw <- exp(coef(fit_raw)[\"treat\"])\n# adjusted gcomp log/poisson of outcome via treatment and covariates\nfit_adj <- glm(vm ~ treat + ag + sg + yr + rc, data = orc, family = poisson())\n# ATE of marginality\ndata_t1 <- copy(orc)[, treat := 1]\ndata_t0 <- copy(orc)[, treat := 0]\nate_gcomp <- mean(predict(fit_adj, data_t1, type = \"response\")) /\n  mean(predict(fit_adj, data_t0, type = \"response\"))\n\nm_near <- matchit(\n  treat ~ ag + sg + yr + rc,\n  data = orc,\n  method = \"nearest\",\n  distance = \"glm\"\n) # PSM\nd_near <- match.data(m_near)\n# psm subclassification: 'subclass' blocks\nm_sub <- matchit(\n  treat ~ ag + sg + yr + rc,\n  data = orc,\n  method = \"subclass\",\n  subclass = 10\n)\nd_sub <- match.data(m_sub)\n\nlibrary(WeightIt)\nlibrary(survey)\n\nw_ipw <- weightit(\n  treat ~ ag + sg + yr + rc,\n  data = orc,\n  method = \"ps\",\n  estimand = \"ATE\"\n)\n\nfit_ipw <- glm(\n  vm ~ treat,\n  data = orc,\n  weights = w_ipw$weights,\n  family = poisson()\n)\n\nlibrary(AIPW)\nlibrary(SuperLearner)\nlibrary(glmmTMB)\nlibrary(pscl)\nresults_list <- list()\n\nresults_list[[\"Baseline_Raw\"]] <- exp(coef(glm(\n  vm ~ treat,\n  data = orc,\n  family = poisson\n))[\"treat\"])\n\nfit_adj <- glm(vm ~ treat + ag + sg + yr + rc, data = orc, family = poisson)\nresults_list[[\"Adjusted_GComp\"]] <- exp(coef(fit_adj)[\"treat\"])\n\nm_near <- matchit(treat ~ ag + sg + yr + rc, data = orc, method = \"nearest\")\nd_near <- match.data(m_near)\nresults_list[[\"PSM_Nearest\"]] <- exp(fixef(glmmTMB(\n  vm ~ treat + ag + sg + yr + (1 | rc),\n  data = d_near,\n  family = poisson\n))$cond[\"treat\"])\n\nm_sub <- matchit(\n  treat ~ ag + sg + yr + rc,\n  data = orc,\n  method = \"subclass\",\n  subclass = 5\n)\nd_sub <- match.data(m_sub)\nresults_list[[\"PSM_Subclass\"]] <- exp(fixef(glmmTMB(\n  vm ~ treat + ag + sg + yr + (1 | rc),\n  data = d_sub,\n  family = poisson\n))$cond[\"treat\"])\n\nw_ipw <- weightit(\n  treat ~ ag + sg + yr + rc,\n  data = orc,\n  method = \"ps\",\n  estimand = \"ATE\"\n)\nresults_list[[\"IPW_Weighted\"]] <- exp(coef(glm(\n  vm ~ treat,\n  data = orc,\n  weights = w_ipw$weights,\n  family = poisson\n))[\"treat\"])\n\n# nb given overdispersion ?:!\nmod_nbin <- glmmTMB(\n  vm ~ treat + ag + sg + yr + (1 | rc),\n  data = d_near,\n  family = nbinom2\n)\nresults_list[[\"NegBinomial\"]] <- exp(fixef(mod_nbin)$cond[\"treat\"])\n\n# zinb\nmod_zinb <- glmmTMB(\n  vm ~ treat + ag + sg + yr + (1 | rc),\n  ziformula = ~1,\n  data = d_near,\n  family = nbinom2\n)\nresults_list[[\"ZINB_Model\"]] <- exp(fixef(mod_zinb)$cond[\"treat\"])\nvalidation_table <- data.frame(\n  Method = names(results_list),\n  IRR_Estimate = unlist(results_list)\n)\nprint(validation_table)\nlibrary(AIPW)\nlibrary(randomForest)\nlibrary(gbm3)\nlibrary(SuperLearner)\nsl_libs <- c(\"SL.glmnet\", \"SL.xgboost\", \"SL.glm\", \"SL.mean\")\ncov <- c(\"ag\", \"sg\", \"yr\", \"rg\")\naipw_obj1a <- AIPW$new(\n  Y = orc_matched$vm,\n  A = orc_matched$treat,\n  W = subset(orc_matched, select = cov),\n  Q.SL.library = sl_libs,\n  g.SL.library = sl_libs,\n  k_split = 10,\n  verbose = TRUE\n)\n\naipw_obj1a$fit()\naipw_obj1a$stratified_fit()\naipw_obj1a$summary()\naipw_obj1a$plot.p_score(print.ip_weights = TRUE)\naipw_obj1a$plot.ip_weights()\n\norcmatch_temp <- copy(orc_matched1b)\norcmatch_temp[, weights := NULL]\norcmatch_temp[, treat := NULL]\norcmatch_temp[, distance := NULL]\norcmatch_temp[, subclass := NULL]\norcmatch_temp[,\n  ag := fcase(\n    ag == 21   , \"21\"   ,\n    ag == 42   , \"42\"   ,\n    ag == 57.5 , \"57.5\"\n  )\n]\norcmatch_temp[, rc := as.factor(rc)]\norcmatch_temp[,\n  ag := factor(ag, levels = c(\"21\", \"42\", \"57.5\"), ordered = TRUE)\n]\norcmatch_temp[, sg := factor(sg)]\norcmatch_temp[, yr := factor(yr, levels = sort(unique(yr)), ordered = TRUE)]\norcmatch_temp$norm_weights <- orcmatch_temp$np / mean(orcmatch_temp$np)\nstr(orcmatch_temp[, .(yr, norm_weights, ag, sg)])\norcmatch_temp[, treat := as.numeric(ac >= median(ac))]\nmodout <- matchit(\n  treat ~ ag + sg + yr + rg,\n  data = orcmatch_temp,\n  distance = \"cbps\",\n  estimand = \"ATC\",\n  distance.options = list(method =\"exact\"),\n  replace = FALSE\n)\nmodout$model$coefficients\nmodout$model$var\nmodout$model$deviance\nmodout$model$J\nmodout$model$mle.J\nmodout$model$method\nmodout$model$terms\nmodout$model$formula\n\nmodsum <- summary(modout)\nsummary(modout)\nmodout1a <- matchit(\n  treat ~ ag + sg + yr + rg,\n  data = orcmatch_temp,\n  distance = \"gam\",\n  replace = TRUE\n)\nmodsum1a <- summary(modout1a$model)\nsummary(modout1a$model)\np.score <- fitted(glm(\n  treat ~ ag + sg + yr + norm_weights,\n  data = orcmatch_temp,\n  family = binomial\n))\nmodout1b <- matchit(\n  treat ~ ag + sg + yr + norm_weights,\n  data = orcmatch_temp,\n  distance = p.score\n)\nmodsum1b <- summary(modout1b$model)\nsummary(modout1b$model)\ny1a <- orcmatch_temp[orcmatch_temp$yr == 2023, ]\ny1b <- orcmatch_temp[orcmatch_temp$yr == 2024, ]\ny1c <- orcmatch_temp[orcmatch_temp$yr == 2025, ]\nfull_mod <- lm(vm ~ . - id, data = orcmatch_temp)\nbackstep <- stats::step(full_mod, direction = \"backward\")\nfrontstep <- stats::step(\n  lm(vm ~ 1, data = orcmatch_temp),\n  scope = formula(full_mod),\n  direction = \"forward\"\n)\nbothstep <- stats::step(full_mod, direction = \"both\")\nsummary(backstep)\nsummary(frontstep)\nsummary(bothstep)\n# plot(bothstep)\nabs_t <- sort(\n  abs(summary(bothstep)$coefficients[, \"t value\"]),\n  decreasing = TRUE\n)\nprint(abs_t)\npar(mfrow = c(2, 2))\nplot(bothstep, ask = FALSE, which = 1:4)\npar(mfrow = c(1, 1))\nlibrary(sjPlot)\nsjPlot::plot_model(\n  bothstep,\n  title = \"Variables selected in Stepwise Regression Model\",\n  subtitle = \"vm ~ ac + a4 + rc + treatment + a8\"\n)\nplot(bothstep, which = 1, main = \"Model Fit\", ask = FALSE)\n\nplot_model(\n  bothstep,\n  title = \"Target Predictors from Stepwise Regression\",\n  sort.est = FALSE,\n  show.values = TRUE,\n  value.offset = 0.4,\n  type = \"std\"\n)\nfinal_covariates <- formula(bothstep)\nprint(final_covariates)\n\nset.seed(36825994)\nfmod <- lm(treat ~ . - id - vm, data = orcmatch_temp)\nbstepz <- stats::step(fmod, direction = \"backward\")\nfstepz <- stats::step(\n  lm(treat ~ 1, data = orcmatch_temp),\n  scope = formula(fmod),\n  direction = \"forward\"\n)\nbothstepz <- stats::step(fmod, direction = \"both\")\nstepform <- formula(bothstepz)\nprint(stepform)\nsummary(bstepz)\nsummary(fstepz)\nsummary(bothstepz)\nfca <- formula(backstep)\nfcb <- formula(frontstep)\nfcc <- formula(bothstep)\nfcd <- formula(bstepz)\nfce <- formula(fstepz)\nfcg <- formula(bothstepz)\nfca\nfcb\nfcc\nfcd\nfce\nfcg\n# plot(bothstep, which = 1:4, ask = FALSE)\nabs_t <- sort(\n  abs(summary(bothstepz)$coefficients[, \"t value\"]),\n  decreasing = TRUE\n)\nprint(abs_t)\npar(mfrow = c(2, 2))\nplot(bothstepz, ask = FALSE, which = 1:4)\npar(mfrow = c(1, 1))\nlibrary(sjPlot)\nsjPlot::plot_model(\n  bothstepz,\n  title = \"Variables selected in Stepwise Regression Model (treatment ~ sg + ac + a1 + a4 + a7 + rc)\"\n)\nmodz <- matchit(\n  treat ~ sg + ac + a1 + a4 + a7 + rc,\n  data = orcmatch_temp,\n  distance = \"cbps\",\n  estimand = \"ATC\",\n  distance.options = list(method = \"exact\"),\n  replace = TRUE\n)\nsummary(modz)\nmodz1a <- match.data(modz)\n\nlibrary(sjmisc)\norcm <- copy(orcmatch_temp)\norcm <- to_factor(orcm, sg, rc, treat)\nmorc <- lm(treat ~ sg + ac + a1 + a4 + a7 + rc, data = orcm)\nsjPlot::plot_model(\n  morc,\n  type = \"pred\",\n  terms = c(\"rc\", \"ac\", \"sg\"),\n  title = \"Stepwise Regression Prediction of Treatment\",\n) +\n  coord_flip() +\n  theme(plot.title = element_text(hjust = 0.5, face = \"bold\"))\n\nsjPlot::plot_model(\n  morc,\n  title = \"Stepwise Regression Prediction of Treatment\",\n  type = \"pred\",\n  terms = c(\"rc\", \"ac\", \"sg\")\n) +\n  theme(\n    plot.title = element_text(hjust = 0.5, face = \"bold\"),\n    axis.text.x = element_text(\n      angle = 45, \n      hjust = 1, \n      vjust = 1,  \n      size = 9   \n    )\n  )  \nplot(bothstep, which = 1:4, ask = FALSE)\nplot(bothstepz, which = 1:4, ask = FALSE)\n```","srcMarkdownNoYaml":""},"formats":{"html":{"identifier":{"display-name":"HTML","target-format":"html","base-format":"html"},"execute":{"fig-width":7,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":"auto","echo":true,"output":true,"warning":false,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"ipynb-shell-interactivity":null,"plotly-connected":true,"message":false,"engine":"knitr"},"render":{"keep-tex":false,"keep-typ":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":"none","code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":"auto","merge-includes":true,"inline-includes":false,"preserve-yaml":false,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-min-runs":1,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[],"notebook-links":true},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","highlight-style":"github","include-in-header":["includez/rename-other-links.html","includez/sidebar-title-home.html"],"output-file":"notez1a.html"},"language":{"toc-title-document":"Table of contents","toc-title-website":"On this page","related-formats-title":"Other Formats","related-notebooks-title":"Notebooks","source-notebooks-prefix":"Source","other-links-title":"Other Links","code-links-title":"Code Links","launch-dev-container-title":"Launch Dev Container","launch-binder-title":"Launch Binder","article-notebook-label":"Article Notebook","notebook-preview-download":"Download Notebook","notebook-preview-download-src":"Download Source","notebook-preview-back":"Back to Article","manuscript-meca-bundle":"MECA Bundle","section-title-abstract":"Abstract","section-title-appendices":"Appendices","section-title-footnotes":"Footnotes","section-title-references":"References","section-title-reuse":"Reuse","section-title-copyright":"Copyright","section-title-citation":"Citation","appendix-attribution-cite-as":"For attribution, please cite this work as:","appendix-attribution-bibtex":"BibTeX citation:","appendix-view-license":"View License","title-block-author-single":"Author","title-block-author-plural":"Authors","title-block-affiliation-single":"Affiliation","title-block-affiliation-plural":"Affiliations","title-block-published":"Published","title-block-modified":"Modified","title-block-keywords":"Keywords","callout-tip-title":"Tip","callout-note-title":"Note","callout-warning-title":"Warning","callout-important-title":"Important","callout-caution-title":"Caution","code-summary":"Code","code-tools-menu-caption":"Code","code-tools-show-all-code":"Show All Code","code-tools-hide-all-code":"Hide All Code","code-tools-view-source":"View Source","code-tools-source-code":"Source Code","tools-share":"Share","tools-download":"Download","code-line":"Line","code-lines":"Lines","copy-button-tooltip":"Copy to Clipboard","copy-button-tooltip-success":"Copied!","repo-action-links-edit":"Edit this page","repo-action-links-source":"View source","repo-action-links-issue":"Report an issue","back-to-top":"Back to top","search-no-results-text":"No results","search-matching-documents-text":"matching documents","search-copy-link-title":"Copy link to search","search-hide-matches-text":"Hide additional matches","search-more-match-text":"more match in this document","search-more-matches-text":"more matches in this document","search-clear-button-title":"Clear","search-text-placeholder":"","search-detached-cancel-button-title":"Cancel","search-submit-button-title":"Submit","search-label":"Search","toggle-section":"Toggle section","toggle-sidebar":"Toggle sidebar navigation","toggle-dark-mode":"Toggle dark mode","toggle-reader-mode":"Toggle reader mode","toggle-navigation":"Toggle navigation","crossref-fig-title":"Figure","crossref-tbl-title":"Table","crossref-lst-title":"Listing","crossref-thm-title":"Theorem","crossref-lem-title":"Lemma","crossref-cor-title":"Corollary","crossref-prp-title":"Proposition","crossref-cnj-title":"Conjecture","crossref-def-title":"Definition","crossref-exm-title":"Example","crossref-exr-title":"Exercise","crossref-ch-prefix":"Chapter","crossref-apx-prefix":"Appendix","crossref-sec-prefix":"Section","crossref-eq-prefix":"Equation","crossref-lof-title":"List of Figures","crossref-lot-title":"List of Tables","crossref-lol-title":"List of Listings","environment-proof-title":"Proof","environment-remark-title":"Remark","environment-solution-title":"Solution","listing-page-order-by":"Order By","listing-page-order-by-default":"Default","listing-page-order-by-date-asc":"Oldest","listing-page-order-by-date-desc":"Newest","listing-page-order-by-number-desc":"High to Low","listing-page-order-by-number-asc":"Low to High","listing-page-field-date":"Date","listing-page-field-title":"Title","listing-page-field-description":"Description","listing-page-field-author":"Author","listing-page-field-filename":"File Name","listing-page-field-filemodified":"Modified","listing-page-field-subtitle":"Subtitle","listing-page-field-readingtime":"Reading Time","listing-page-field-wordcount":"Word Count","listing-page-field-categories":"Categories","listing-page-minutes-compact":"{0} min","listing-page-category-all":"All","listing-page-no-matches":"No matching items","listing-page-words":"{0} words","listing-page-filter":"Filter","draft":"Draft"},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"1.8.26","bibliography":["references.bib"],"pdf":{"documentclass":"scrreprt"},"epub":{"cover-image":"cvr1b.png"},"respect-user-color-scheme":true,"theme":{"light":["cosmo","brand"],"dark":["darkly","dracula"]},"comments":{"hypothesis":false},"other-links":[{"text":"Partial Notebook","href":"https://vanshsinghruhela-statistical-report-on-restrictive-confinement.share.connect.posit.cloud"},{"text":"Prelim. DPR","href":"https://vanshsinghruhela-statistical-report-on-restrictive-confinement.share.connect.posit.cloud/prelim_report.html"},{"text":"Row Exp. DPR","href":"https://vanshsinghruhela-statistical-report-on-restrictive-confinement.share.connect.posit.cloud/final_report.html"}],"cold-fold":true},"extensions":{"book":{"multiFile":true}}},"docx":{"identifier":{"display-name":"MS Word","target-format":"docx","base-format":"docx"},"execute":{"fig-width":5,"fig-height":4,"fig-format":"png","fig-dpi":96,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":"auto","echo":true,"output":true,"warning":false,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"ipynb-shell-interactivity":null,"plotly-connected":true,"message":false,"engine":"knitr"},"render":{"keep-tex":false,"keep-typ":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"docx","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":"none","code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":true,"merge-includes":true,"inline-includes":false,"preserve-yaml":false,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-min-runs":1,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[],"page-width":6.5},"pandoc":{"default-image-extension":"png","to":"docx","output-file":"notez1a.docx"},"language":{"toc-title-document":"Table of contents","toc-title-website":"On this page","related-formats-title":"Other Formats","related-notebooks-title":"Notebooks","source-notebooks-prefix":"Source","other-links-title":"Other Links","code-links-title":"Code Links","launch-dev-container-title":"Launch Dev Container","launch-binder-title":"Launch Binder","article-notebook-label":"Article Notebook","notebook-preview-download":"Download Notebook","notebook-preview-download-src":"Download Source","notebook-preview-back":"Back to Article","manuscript-meca-bundle":"MECA Bundle","section-title-abstract":"Abstract","section-title-appendices":"Appendices","section-title-footnotes":"Footnotes","section-title-references":"References","section-title-reuse":"Reuse","section-title-copyright":"Copyright","section-title-citation":"Citation","appendix-attribution-cite-as":"For attribution, please cite this work as:","appendix-attribution-bibtex":"BibTeX citation:","appendix-view-license":"View License","title-block-author-single":"Author","title-block-author-plural":"Authors","title-block-affiliation-single":"Affiliation","title-block-affiliation-plural":"Affiliations","title-block-published":"Published","title-block-modified":"Modified","title-block-keywords":"Keywords","callout-tip-title":"Tip","callout-note-title":"Note","callout-warning-title":"Warning","callout-important-title":"Important","callout-caution-title":"Caution","code-summary":"Code","code-tools-menu-caption":"Code","code-tools-show-all-code":"Show All Code","code-tools-hide-all-code":"Hide All Code","code-tools-view-source":"View Source","code-tools-source-code":"Source Code","tools-share":"Share","tools-download":"Download","code-line":"Line","code-lines":"Lines","copy-button-tooltip":"Copy to Clipboard","copy-button-tooltip-success":"Copied!","repo-action-links-edit":"Edit this page","repo-action-links-source":"View source","repo-action-links-issue":"Report an issue","back-to-top":"Back to top","search-no-results-text":"No results","search-matching-documents-text":"matching documents","search-copy-link-title":"Copy link to search","search-hide-matches-text":"Hide additional matches","search-more-match-text":"more match in this document","search-more-matches-text":"more matches in this document","search-clear-button-title":"Clear","search-text-placeholder":"","search-detached-cancel-button-title":"Cancel","search-submit-button-title":"Submit","search-label":"Search","toggle-section":"Toggle section","toggle-sidebar":"Toggle sidebar navigation","toggle-dark-mode":"Toggle dark mode","toggle-reader-mode":"Toggle reader mode","toggle-navigation":"Toggle navigation","crossref-fig-title":"Figure","crossref-tbl-title":"Table","crossref-lst-title":"Listing","crossref-thm-title":"Theorem","crossref-lem-title":"Lemma","crossref-cor-title":"Corollary","crossref-prp-title":"Proposition","crossref-cnj-title":"Conjecture","crossref-def-title":"Definition","crossref-exm-title":"Example","crossref-exr-title":"Exercise","crossref-ch-prefix":"Chapter","crossref-apx-prefix":"Appendix","crossref-sec-prefix":"Section","crossref-eq-prefix":"Equation","crossref-lof-title":"List of Figures","crossref-lot-title":"List of Tables","crossref-lol-title":"List of Listings","environment-proof-title":"Proof","environment-remark-title":"Remark","environment-solution-title":"Solution","listing-page-order-by":"Order By","listing-page-order-by-default":"Default","listing-page-order-by-date-asc":"Oldest","listing-page-order-by-date-desc":"Newest","listing-page-order-by-number-desc":"High to Low","listing-page-order-by-number-asc":"Low to High","listing-page-field-date":"Date","listing-page-field-title":"Title","listing-page-field-description":"Description","listing-page-field-author":"Author","listing-page-field-filename":"File Name","listing-page-field-filemodified":"Modified","listing-page-field-subtitle":"Subtitle","listing-page-field-readingtime":"Reading Time","listing-page-field-wordcount":"Word Count","listing-page-field-categories":"Categories","listing-page-minutes-compact":"{0} min","listing-page-category-all":"All","listing-page-no-matches":"No matching items","listing-page-words":"{0} words","listing-page-filter":"Filter","draft":"Draft"},"metadata":{"bibliography":["references.bib"],"pdf":{"documentclass":"scrreprt"},"epub":{"cover-image":"cvr1b.png"}},"extensions":{"book":{"selfContainedOutput":true}}}},"projectFormats":["html","docx"]}